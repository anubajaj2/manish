sap.ui.define(["sap/ui/demo/cart/controller/BaseController","sap/ui/demo/cart/model/formatter","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/Image","sap/m/Dialog","sap/m/Carousel","sap/m/Button","sap/m/MessageBox","sap/m/SelectDialog"],function(e,t,r,s,o,a,i,d,u,h,n,g,l,c){"use strict";return e.extend("sap.ui.demo.cart.controller.CustomerOrders",{formatter:t,onInit:function(){debugger;this._oRouter=this.getOwnerComponent().getRouter();this._oRouter.getRoute("orders").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){if(!this.orderStatusList){this.getView().setBusy(true);this.loadOrderStatus()}},setOrderStatus:function(e,t){var r=0;var s=0;var o=0;var a=0;var i=[];t.orderStatusList=[];e.get("OrderHeader").forEach((d,u)=>{s=0;o=0;a=0;i=[];if(e.get("OrderItem").has(u)){e.get("OrderItem").get(d.id).forEach((t,r)=>{i.push(r+1);var d=e.get("Product").get(t.Material);var u=d.Tunch+d.Wastage;i.push(d.Category.toLowerCase()+" / "+d.SubCategory.toLowerCase()+" / "+d.Name.toLowerCase()+" ("+u+"Tunch) ");s+=e.get("Weight").get(t.WeightId).GrossWeight;i.push(e.get("Weight").get(t.WeightId).GrossWeight);a+=e.get("Weight").get(t.WeightId).NetWeight;i.push(e.get("Weight").get(t.WeightId).NetWeight);o+=e.get("Weight").get(t.WeightId).Amount;i.push(e.get("Weight").get(t.WeightId).Amount)})}t.orderStatusList[r++]={id:u,CustomerName:e.get("Customer").get(d.Customer).Name,CustomerCode:e.get("Customer").get(d.Customer).CustomerCode,CustomerCity:e.get("Customer").get(d.Customer).City,CustomerMob:e.get("Customer").get(d.Customer).MobilePhone,TotalWeight:s.toFixed(2),TotalNetWeight:a,TotalAmount:o,OrderDate:d.Date,OrderNo:d.OrderNo,OrderStatus:d.Status,ItemDetails:i}});t.getOwnerComponent().getModel("local").setProperty("/list",{OrderHeader:t.orderStatusList});this.getView().byId("idListOL").removeSelections();this.orderHeader=e;if(this.orderStatusList.length){var d=this.orderStatusList[0].id;var u=[];this.orderHeader.get("OrderItem").get(d).forEach(e=>{u.push(this.orderHeader.get("Product").get(e.Material))});this.getOwnerComponent().getModel("local").setProperty("/CustomerOrderItems",u)}this.getView().setBusy(false)},loadProdWeights:function(e,t){var r=[];e.get("Weight").forEach((e,t)=>{r.push(new sap.ui.model.Filter("id","EQ","'"+t+"'"))});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/ProdWeights","GET",{filters:r},{},this).then(function(r){r.results.forEach(t=>{e.get("Weight").set(t.id,t)});t.setOrderStatus(e,t)}).catch(function(e){t.getView().setBusy(false);a.show("Cannot fetch Order Status please Refresh")})},loadProducts:function(e,t){var r=[];e.get("Product").forEach((e,t)=>{r.push(new sap.ui.model.Filter("id","EQ","'"+t+"'"))});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Products","GET",{filters:r},{},this).then(function(r){r.results.forEach(t=>{e.get("Product").set(t.id,t)});t.loadProdWeights(e,t)}).catch(function(e){t.getView().setBusy(false);a.show("Cannot fetch Order Status please Refresh")})},loadOrderItems:function(e,t){var r=[];e.get("OrderHeader").forEach((e,t)=>{r.push(new sap.ui.model.Filter("OrderNo","EQ","'"+t+"'"))});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderItems","GET",{filters:r},{},this).then(function(r){r.results.forEach(t=>{if(e.get("OrderItem").has(t.OrderNo)){e.get("OrderItem").get(t.OrderNo).push(t);e.get("Weight").set(t.WeightId,"");e.get("Product").set(t.Material,"")}});t.loadProducts(e,t)}).catch(function(e){t.getView().setBusy(false);a.show("Cannot fetch Order Status please Refresh")})},loadCustomer:function(e,t){var r=this;t.set("Customer",new Map);var s=[];e.forEach(e=>{s.push(new sap.ui.model.Filter("id","EQ","'"+e+"'"))});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Customers","GET",{filters:s},{},this).then(function(e){e.results.forEach(e=>{t.get("Customer").set(e.id,e)})}).catch(function(e){r.getView().setBusy(false);a.show("Cannot fetch Order Status please Refresh")})},loadOrderStatus:function(){var e=this;var t=this.getView().getModel("local").getProperty("/CustomerData/id");var r=new Set;var s=new Map;s.set("OrderHeader",new Map);s.set("OrderItem",new Map);s.set("Product",new Map);s.set("Weight",new Map);var o=new sap.ui.model.Filter("Customer","EQ","'"+t+"'");this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderHeaders","GET",{filters:[o]},{},this).then(function(t){t.results.forEach((e,t)=>{s.get("OrderHeader").set(e.id,e);s.get("OrderItem").set(e.id,[]);r.add(e.Customer)});e.loadCustomer(r,s);e.loadOrderItems(s,e)}).catch(function(t){e.getView().setBusy(false);a.show("Cannot fetch Order Status please Refresh")})},onRefresh:function(){this.getView().setBusy(true);this.loadOrderStatus()},onItemPress:function(e){var t=e.getSource().getSelectedContextPaths()[0];var r=t.split("/")[t.split("/").length-1];var s=this.orderStatusList[r].id;var o=[];this.orderHeader.get("OrderItem").get(s).forEach(e=>{o.push(this.orderHeader.get("Product").get(e.Material))});this.getOwnerComponent().getModel("local").setProperty("/CustomerOrderItems",o)}})});