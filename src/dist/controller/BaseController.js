sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/core/UIComponent","sap/ui/core/routing/History","sap/ui/demo/cart/model/cart","sap/ui/demo/cart/dbapi/dbapi","sap/f/LayoutType","sap/ui/demo/cart/model/formatter","sap/ui/core/Fragment","sap/m/MessageBox"],function(e,t,o,r,a,s,i,n,l,g){"use strict";return e.extend("sap.ui.demo.cart.controller.BaseController",{cart:a,ODataHelper:s,formatter:n,cleanApp:function(){this.getOwnerComponent().getModel("local").setProperty("/cartItems",[])},onInit:function(){},closePopover:function(){this._oPopover.destroy();this._oPopover=null},onUserPress:function(e){var t=e.getSource();if(!this._oPopover){l.load({id:"popoverNavCon",name:"sap.ui.demo.cart.fragments.Profile",controller:this}).then(function(e){this._oPopover=e;this.getView().addDependent(this._oPopover);this._oPopover.openBy(t);if(this.getView().getModel("local").getProperty("/Role")!="Retailer"){this._oPopover.getContent()[0].getPages()[0].getContent()[0].getItems()[1].setVisible(false)}}.bind(this))}else{this._oPopover.openBy(t);if(this.getView().getModel("local").getProperty("/Role")!="Retailer"){this._oPopover.getContent()[0].getPages()[0].getContent()[0].getItems()[1].setVisible(false)}}},showProfile:function(e){this._oPopover.setContentWidth("25%");this._oPopover.setContentHeight("60%");var t=l.byId("popoverNavCon","navCon");var o=l.byId("popoverNavCon","detail");t.to(o);this._oPopover.focus()},onOrders:function(e){if(this.getView().getModel("local").getProperty("/Role")==="Retailer"){this.getRouter().navTo("orders")}},onNavBack:function(e){this._oPopover.setContentWidth("18%");this._oPopover.setContentHeight("11%");var t=l.byId("popoverNavCon","navCon");t.back();this._oPopover.focus()},_allWeights:[],reverseSort:function(e,t){var o=[];for(var r=0;r<e.length;r++){o.push(e[r].split("/")[e[r].split("/").length-1])}o.sort(function(e,t){return t-e});var a=[];for(var r=0;r<o.length;r++){a.push("/"+t+"/"+o[r])}return a},_deletedImages:[],ProdWeights:[],validateProductData:function(){var e=this.getView().getModel("local").getProperty("/ProdWeights");var t=this.getView().getModel("local").getProperty("/Product");if(t.ProductId===""||t.ProductId==="null"){return{status:false,error:"Product Id not valid"}}if(t.Name===""||t.Name==="null"){return{status:false,error:"Product Name not valid"}}if(t.Tunch===""||t.Tunch==="null"||t.Tunch==="0"||parseInt(t.Tunch)===0){return{status:false,error:"Tunch is not valid"}}if(parseInt(t.Tunch)>100){return{status:false,error:"Tunch is not valid"}}if(parseInt(t.Wastage)>100){return{status:false,error:"Wastage is not valid"}}if(parseInt(t.Making)>9999){return{status:false,error:"Making not valid"}}if(e.length<=0){return{status:false,error:"at least one weight required"}}for(var o=0;o<e.length;o++){if(e[o].Fine===""||e[o].Fine==="0"||parseInt(e[o].Fine)===0||parseInt(e[o].Fine)<0||e[o].Fine==="null"){return{status:false,error:"Fine cannot be calculated"}}}return{status:true,error:""}},prepareFinalData:function(e){var t=this.getView().getModel("local").getProperty("/ProdWeights");for(var o=0;o<t.length;o++){t[o].ProductId=e}var r=this.getView().getModel("local").getProperty("/allImages");for(var a=0;a<r.length;a++){if(!r[a].id){r[a].Product=e}}this.getView().getModel("local").setProperty("/allImages",r);this.getView().getModel("local").setProperty("/ProdWeights",t)},performCameraSave:function(e){this.prepareFinalData(e);this.massImageDelete();this.handleUploadPress();this.upsertWeights();this.getView().getModel("local").setProperty("/checkChange",false)},loadProdWeights:function(e){var t=this;return new Promise(function(o,r){$.post("/GetProdWeights",{productId:e}).done(function(e,r){t.getView().getModel("local").setProperty("/ProdWeights",e.ProdWeights);o(e)}).fail(function(e,t,o){r(o)})})},loadProdInitImages:function(e){},loadProdAllImages:function(e){var t=this;$.post("/GetAllPhotos",{productId:e}).done(function(e,o){t._deletedImages=[];t.getView().getModel("local").setProperty("/allImages",e.allImages);t.processImages()}).fail(function(e,t,o){})},loadProductData:function(e){var t=this;if(e!==""&&!e){return}this.loadProdAllImages(e);this.loadProdWeights(e)},mode:"Create",cancelSave:function(){var e=this;if(e.getView().getModel("local").getProperty("/checkChange")===true){g.confirm("Unsaved data will be lost",{title:"Confirmation",type:"Warning",onClose:function(t){if(t==="OK"){e._deletedImages=[];e.getView().getModel("local").setProperty("/Product",{id:"",ProductId:"",Name:"",Category:"",SubCategory:"",Type:"S",PairType:2,ShortDescription:"null",ItemType:"G",Karat:"22/22",Gender:"F",OverallStatus:"N",HindiName:"",Tunch:0,Wastage:0,Making:0,ApprovedOn:"",AlertQuantity:0,CreatedBy:"",CreatedOn:"",ChangedBy:"",ChangedOn:""});e.mode="Create";e.setMode()}else{return false}}})}else{this._deletedImages=[];this.getView().getModel("local").setProperty("/ProdWeights",[{ProductId:"null",PairSize:0,OtherChrg:0,GrossWeight:0,LessWeight:0,NetWeight:0,Quantity:1,Fine:0,MoreAmount:0,Amount:0,Values:[],Status:"A",SoldOn:new Date,OrderId:"",Remarks:"null",CreatedOn:new Date,CreatedBy:""}]);this.getView().getModel("local").setProperty("/allImages",[]);this.getView().getModel("local").setProperty("/deleteImages",[]);e.getView().getModel("local").setProperty("/checkChange",false);return true}},setMode:function(){if(this.mode==="Edit"){this.getView().byId("idName").setEnabled(false);this.getView().byId("idPName").focus()}else if(this.mode="Copy"){var e=this.getView().getModel("local").getProperty("/ProdWeights");e.forEach(e=>{e.ProductId="";e.SoldOn=new Date;e.CreatedOn=new Date;delete e.id});this.getView().getModel("local").setProperty("/ProdWeights",e);var t=this.getView().getModel("local").getProperty("/allImages");t.forEach(e=>{e.Product="";e.CreatedOn=new Date;delete e.id});this.getView().getModel("local").setProperty("/allImages",t);this.getView().getModel("local").setProperty("/deleteImages",[]);this.getView().getModel("local").setProperty("/checkChange",false);if(this.getView().byId("idName")){this.getView().byId("idName").setEnabled(true)}}else{this._deletedImages=[];this.getView().getModel("local").setProperty("/ProdWeights",[{ProductId:"null",PairSize:0,OtherChrg:0,GrossWeight:0,LessWeight:0,NetWeight:0,Quantity:1,Fine:0,MoreAmount:0,Amount:0,Values:[],Status:"A",SoldOn:new Date,OrderId:"",Remarks:"null",CreatedOn:new Date,CreatedBy:""}]);this.getView().getModel("local").setProperty("/allImages",[]);this.getView().getModel("local").setProperty("/deleteImages",[]);this.getView().getModel("local").setProperty("/checkChange",false);if(this.getView().byId("idName")){this.getView().byId("idName").setEnabled(true)}}},massImageDelete:function(){var e=this;this._deletedImages=this.getView().getModel("local").getProperty("/deleteImages");if(!this._deletedImages){return}if(this._deletedImages.length===0){return}$.post("/DeletePhotos",{images:this._deletedImages}).done(function(t,o){e.getView().getModel("local").setProperty("/deleteImages",[])}).fail(function(e,t,o){})},upsertWeights:function(){var e=this;var t=this.getView().getModel("local").getProperty("/ProdWeights");if(t.length===0){return}$.post("/ProdWeights",{ProdWeights:t}).done(function(t,o){e.ProdWeights=t.ProdWeights;e.getView().getModel("local").setProperty("/ProdWeights",e.ProdWeights)}).fail(function(e,t,o){g.error("Internal error occurred")})},handleUploadPress:function(e){var t=[];var o=this.getView().getModel("local").getProperty("/allImages");for(var r=0;r<o.length;r++){if(!o[r].id){t.push({SeqNo:r,Product:o[r].Product,Stream:o[r].Stream,Content:o[r].Content,Filename:"",Filetype:"",ViewCount:0,LastDate:new Date,CreatedBy:this.getView().getModel("local").getProperty("/CurrentUser"),CreatedOn:new Date})}}if(t.length===0){return}var a=this;$.post("/Photos",{images:t}).done(function(e,t){a.getView().getModel("local").setProperty("/allImages",e.allImages);a.processImages()}).fail(function(e,t,o){})},processImages:function(){var e=this.getView().getModel("local").getProperty("/allImages");for(var t=0;t<e.length;t++){e[t].Stream=n.getImageUrlFromContent(e[t].Content)}this.getView().getModel("local").setProperty("/allImages",e)},calculateOrderEstimate:function(){var e=this.getModel("local").getProperty("/cartItems");var t=0;var o=0;for(var r=0;r<e.length;r++){var a=e[r].NetWeight;var s=e[r].Amount;o=o+a;t=t+s;a=0;s=0}this.getModel("local").setProperty("/fineGm",o.toFixed(3));this.getModel("local").setProperty("/fineRs",t)},firstTwoDisplay:function(){this.getModel("local").setProperty("/layout",i.TwoColumnsMidExpanded)},lastTwoDisplay:function(e){this.getModel("local").setProperty("/layout",i.ThreeColumnsMidExpanded)},getRouter:function(){return o.getRouterFor(this)},loadCategories:function(e){var o=this;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/ProductCategories","GET",{},{},this).then(function(t){var r=[];var a=[];for(var s=0;s<t.results.length;s++){if(r.indexOf(t.results[s].Category)===-1){r.push(t.results[s])}}var i=[];var n=[];if(e){if(e.length>0){for(var s=0;s<t.results.length;s++){for(var l=0;l<e.length;l++){if(e[l]===t.results[s].id){i.push(t.results[s])}}}}}else{for(var s=0;s<t.results.length;s++){if(i.indexOf(t.results[s].SubCategory)===-1){i.push(t.results[s])}}}r=o.removeDuplicates(r,"Category");i=o.removeDuplicates(i,"SubCategory");o.getOwnerComponent().getModel("local").setProperty("/cat",{category:r,subCatergory:i,type:[{Type:"Plain",Key:"P"},{Type:"Studded",Key:"S"}]})}).catch(function(e){t.show("cannot fetch the data")})},removeDuplicates:function(e,t){var o=[];var r={};for(var a in e){r[e[a][t]]=e[a]}for(a in r){o.push(r[a])}return o},getModel:function(e){return this.getView().getModel(e)},setModel:function(e,t){return this.getView().setModel(e,t)},logOutApp:function(){g.alert("Logout Successful");window.top.location.href="/"},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},onAvatarPress:function(){var e=this.getResourceBundle().getText("avatarButtonMessageToastText");t.show(e)},onStateChange:function(e){},_setLayout:function(e){if(e){this.getModel("local").setProperty("/layout",e+"Column"+(e==="One"?"":"sMidExpanded"))}},_unhideMiddlePage:function(){setTimeout(function(){this.getOwnerComponent().getRootControl().getContent()[0].getPages()[1].byId("layout").getCurrentMidColumnPage().removeStyleClass("sapMNavItemHidden")}.bind(this),0)},onBack:function(){this._unhideMiddlePage();var e=r.getInstance();var t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{this.getRouter().navTo("home")}},onAddToCart:function(){var e=this.getOwnerComponent().getModel("i18n").getResourceBundle();var t=arguments[0].getSource().getBindingContext().getObject();var o=this.getView().getModel("cartProducts");a.addToCart(e,t,o)}})});