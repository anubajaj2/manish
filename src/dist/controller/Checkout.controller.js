sap.ui.define(["sap/ui/demo/cart/controller/BaseController","sap/ui/demo/cart/model/cart","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ui/demo/cart/model/formatter","sap/m/MessageBox","sap/m/MessageToast","sap/m/Link","sap/m/MessagePopover","sap/m/MessagePopoverItem","sap/ui/demo/cart/model/EmailType","sap/ui/core/HTML"],function(e,t,o,r,a,n,s,i,g,c,l,d){"use strict";return e.extend("sap.ui.demo.cart.controller.Checkout",{formatter:a,onInit:function(){this.setModel(this.getOwnerComponent().getModel("local"),"local");this._oLocalModel=this.getOwnerComponent().getModel("local");this.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");this._oRouter=this.getOwnerComponent().getRouter();this._oRouter.getRoute("checkout").attachMatched(this._routePatternMatched,this)},_routePatternMatched:function(){this._setLayout("One");if(this.getView().byId("wizardNavContainer")._pageStack.length>1){this.getView().byId("wizardNavContainer")._pageStack.pop();this.getView().byId("shoppingCartWizard").setCurrentStep(this.getView().byId("shoppingCartWizard").getSteps()[0])}this.calculateOrderEstimate()},onChangeQty:function(){this.calculateOrderEstimate()},onShowMessagePopoverPress:function(e){var t=e.getSource();var o=new i({text:"Show more information",href:"http://sap.com",target:"_blank"});var r=new c({type:"{message>type}",title:"{message>message}",subtitle:"{message>additionalText}",link:o});if(!this.byId("errorMessagePopover")){var a=new g(this.createId("messagePopover"),{items:{path:"message>/",template:r},afterClose:function(){a.destroy()}});this._addDependent(a)}a.openBy(t)},_addDependent:function(e){this.getView().addDependent(e)},handleWizardCancel:function(){var e=this.getResourceBundle().getText("checkoutControllerAreYouSureCancel");this._handleSubmitOrCancel(e,"warning","home")},handleWizardSubmit:function(){var e=this.getResourceBundle().getText("checkoutControllerAreYouSureSubmit");this._handleSubmitOrCancel(e,"confirm","ordercompleted")},backToWizardContent:function(){this.byId("wizardNavContainer").backToPage(this.byId("wizardContentPage").getId())},_clearMessages:function(){sap.ui.getCore().getMessageManager().removeAllMessages()},checkContentStep:function(){},checkPaymentTypeStepStep:function(){return true},onCheckStepActivation:function(e){this._clearMessages();var t=e.getSource().getId();switch(t){case this.createId("contentsStep"):this.checkContentStep();break;case this.createId("paymentTypeStep"):this.checkPaymentTypeStepStep();break}},checkInvoiceStep:function(){},_checkStep:function(e,t){var o=this.byId("shoppingCartWizard"),r=this.byId(e),a=this._checkInputFields(t),n=!!sap.ui.getCore().getMessageManager().getMessageModel().getData().length;if(!n&&!a){o.validateStep(r)}else{o.invalidateStep(r)}},getOrderSummary:function(e,t){var o="";var r=0;var a=0;e.forEach(e=>{o+='<li><p style="font-weight:500;font-size:larger;"> Item : '+e.Category+" / "+e.SubCategory+" / "+e.Name+"<br> Gross Weight : "+e.GrossWeight+" g"+", &nbsp;&nbsp;&nbsp;&nbsp;Net Weight : "+e.NetWeight+" g"+"<br>Amount : "+e.Amount+" INR</p></li>";r+=e.Amount;a+=e.GrossWeight});var n=this.getOwnerComponent().getModel("local").getProperty("/CustomerData");o='<h1 style="color:green; font-weight:800; font-size:xx-large;">Order Summary</h1><hr>'+'<p style="color:green; font-weight:600; font-size:x-large;">Name : '+n.Name+" &nbsp;&nbsp;&nbsp;&nbsp; "+" &nbsp;&nbsp;&nbsp;&nbsp;Date : "+Date().slice(0,24)+" IST<br>Code &nbsp;: "+n.CustomerCode+"</p>"+"<ol>"+o+"</ol>"+'<p style="color:green; font-weight:600; font-size:x-large;">Total Amount : '+r+" INR&nbsp;&nbsp;&nbsp;&nbsp; "+" &nbsp;&nbsp;&nbsp;&nbsp;Total Weight : "+a.toFixed(2)+" g</p>";var s=t.getOwnerComponent().getModel("local").getProperty("/orderNo");o+='<p style="color:blue; font-weight:600; font-size:x-large;">Your Order Number is '+s+" , Please check your email for more details</p>";t.getOwnerComponent().getModel("local").setProperty("/OrderSummaryHTML",o)},saveOrderItem:function(e,t,o,r,a=0){if(a<t.length){o.OrderNo=e;o.Material=t[a].ProductId;o.WeightId=t[a].WeightId;r.ODataHelper.callOData(r.getOwnerComponent().getModel(),"/OrderItems","POST",{},o,r).then(function(n){r.saveOrderItem(e,t,o,r,++a);s.show("Order items saved successfully")}).catch(function(e){n.error("Error while saving order Item data")})}else{r.getView().setBusy(false);r.getOrderSummary(t,r);r.byId("wizardNavContainer").to(this.byId("summaryPage"))}},checkCompleted:function(){if(sap.ui.getCore().getMessageManager().getMessageModel().getData().length>0){n.error(this.getResourceBundle().getText("popOverMessageText"))}else{var e=this.getOwnerComponent().getModel("local").getProperty("/OrderHeader");var t=this.getOwnerComponent().getModel("local").getProperty("/cartItems");var o=this.getOwnerComponent().getModel("local").getProperty("/OrderItem");e.OrderNo=this.getOwnerComponent().getModel("local").getProperty("/orderNo");e.Date=Date();e.ApprovedOn=Date();e.Customer=this.getOwnerComponent().getModel("local").getProperty("/CustomerData/id");this.getOwnerComponent().getModel("local").setProperty("/OrderHeader",e);var r=this;if(t.length){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderHeaders","POST",{},e,this).then(function(e){r.saveOrderItem(e.id,t,o,r)}).catch(function(e){n.error("Error while saving product data")});r.getView().setBusy(true)}else{n.error("Cart is Empty")}}},restartOrder:function(){this.cleanApp();this._oRouter.navTo("categories")},closeApp:function(){window.close()},onReturnToShopButtonPress:function(){this.firstTwoDisplay();this.getRouter().navTo("categories")},_navBackToStep:function(e){var t=e.getSource().data("navBackTo");var o=this.byId(t);this._navToWizardStep(o)},_navToWizardStep:function(e){var t=this.byId("wizardNavContainer");var o=function(){this.byId("shoppingCartWizard").goToStep(e);t.detachAfterNavigate(o)}.bind(this);t.attachAfterNavigate(o);t.to(this.byId("wizardContentPage"))}})});