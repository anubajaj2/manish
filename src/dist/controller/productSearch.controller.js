sap.ui.define(["sap/ui/demo/cart/controller/BaseController","sap/ui/demo/cart/model/formatter","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/Image","sap/m/Dialog","sap/m/Carousel","sap/m/Button","sap/m/MessageBox","sap/m/SelectDialog"],function(e,t,o,r,i,a,s,n,g,l,h,d,c,p){"use strict";return e.extend("sap.ui.demo.cart.controller.productSearch",{formatter:t,onInit:function(){debugger;this._oRouter=this.getOwnerComponent().getRouter();this._oRouter.getRoute("productSearch").attachMatched(this._onRouteMatched,this);this._oLocalModel=this.getOwnerComponent().getModel("local")},_onRouteMatched:function(e){var t=this.getView().byId("gridList");t.getBinding("items");var o=this._oLocalModel.getProperty("/searchFilter");t.getBinding("items").filter(o);this.loadedWeights=[];t.attachUpdateFinished(this.counter,this)},allImageURLs:[],counter:function(e){var o=e.getSource().getItems();var r=this.getView().getModel("local");var i=this.getView().getModel();for(var a=0;a<o.length;a++){var s=o[a].getBindingContextPath();debugger;var n=i.getProperty(s+"/ToPhotos");var g=s+"/ToPhotos/0/Content";var l=t.getImageUrlFromContent(i.getProperty(g));if(!this.allImageURLs[g]){this.allImageURLs[g]=l}if(n.length>1){var g=s+"/ToPhotos/1/Content";var l=t.getImageUrlFromContent(i.getProperty(g));if(!this.allImageURLs[g]){this.allImageURLs[g]=l}}if(n.length>2){var g=s+"/ToPhotos/2/Content";var l=t.getImageUrlFromContent(i.getProperty(g));if(!this.allImageURLs[g]){this.allImageURLs[g]=l}}if(n.length>3){var g=s+"/ToPhotos/3/Content";var l=t.getImageUrlFromContent(i.getProperty(g));if(!this.allImageURLs[g]){this.allImageURLs[g]=l}}if(n.length>4){var g=s+"/ToPhotos/4/Content";var l=t.getImageUrlFromContent(i.getProperty(g));if(!this.allImageURLs[g]){this.allImageURLs[g]=l}}o[a].getContent()[1].getItems()[0].setSrc(l)}},onImageOut:function(e){var t=e.getSource().getParent().getParent().getBindingContextPath();var o=t+"/ToPhotos/1/Content";if(this.allImageURLs[o]){e.getSource().setSrc(this.allImageURLs[o])}},onImageIn:function(e){var t=e.getSource().getParent().getParent().getBindingContextPath();var o=t+"/ToPhotos/0/Content";e.getSource().setSrc(this.allImageURLs[o])},addProductToCart:function(e,t,o){var r=this.getOwnerComponent().getModel("local").getProperty("/cartItems");var i={};i.Name=e.Name;i.ProductId=e.id;i.Tunch=e.Tunch;i.Category=e.Category;i.SubCategory=e.SubCategory;i.PictureUrl=o;for(var a=0;a<t.length;a++){i.GrossWeight=t[a].GrossWeight;i.NetWeight=t[a].NetWeight;i.Amount=t[a].Amount;i.WeightId=t[a].id;r.push(JSON.parse(JSON.stringify(i)))}this.getOwnerComponent().getModel("local").setProperty("/cartItems",r);this.calculateOrderEstimate()},removeProductFromCart:function(e,t){var o=this.getOwnerComponent().getModel("local").getProperty("/cartItems");for(var r=0;r<o.length;r++){if(o[r].WeightId===t.id){o.splice(r,1);break}}this.getOwnerComponent().getModel("local").setProperty("/cartItems",o)},selectedWeights:function(e){var t=[];var o=e.getParameter("selectedItems");var r=this.oBtn.getParent().getModel().getProperty(this.sPath);if(o.length>0){for(var i=0;i<o.length;i++){var a=o[i].getModel().getProperty(o[i].getBindingContextPath());var s=this.getOwnerComponent().getModel("local").getProperty("/addedWeights");s.push(a);this.getOwnerComponent().getModel("local").setProperty("/addedWeights",s);t.push(a)}}this.addProductToCart(r,t,this.allImageURLs[this.sPath+"/ToPhotos/0/Content"])},loadedWeights:[],closeWeights:function(){this.oDialog.close()},onAddToCart:function(e){var t=e.getSource();var o=t.getParent().getBindingContext().getPath();this.oBtn=t;this.sPath=o;var r=this;if(!this.loadedWeights[o]){this.loadProdWeights(o.split("'")[o.split("'").length-2]).then(function(e){debugger;r.loadedWeights[o]=e.ProdWeights;r.getView().getModel("local").setProperty("/ProdWeights",e.ProdWeights);r.oDialog=new p({title:"Select weights",multiSelect:true,confirm:r.selectedWeights.bind(r),close:r.closeWeights});r.getView().addDependent(r.oDialog);r.oDialog.setModel(r._oLocalModel);r.oDialog.bindAggregation("items",{path:"/ProdWeights",template:new sap.m.DisplayListItem({label:"{NetWeight} gm",value:"{Amount} INR"})});r.oDialog.open()})}else{var i=JSON.parse(JSON.stringify(this.loadedWeights[o]));var a=this.getOwnerComponent().getModel("local").getProperty("/addedWeights");if(a.length>0){for(var s=0;s<i.length;s++){for(var n=0;n<a.length;n++){if(i[s].id===a[n].id){i.splice(s,1)}}}}this.getView().getModel("local").setProperty("/ProdWeights",i);this.oDialog.open()}},onCartClick:function(e){this.getRouter().navTo("comparisonCart")},getGridItemById:function(e){var t=this.getView().byId("gridList").getItems();for(var o=0;o<t.length;o++){if(t[o].getBindingContextPath().indexOf(e)!=-1){return t[o]}}},getButtonInsideGrid:function(e){var t=this.getGridItemById(e);return t.getContent()[2].getItems()[0]},alldeleted:[],onCartItemDelete:function(e){var t=e.getParameter("listItem").getModel("local").getProperty(e.getParameter("listItem").getBindingContextPath());var o=t.id;this.removeProductFromCart(t);var r=this.getButtonInsideGrid(o);r.setIcon("sap-icon://cart-3");r.setType("Default");r.setPressed(false)},onOrder:function(){a.show("Order has been sent for approval, please check your email!")},onCloseCart:function(){this._oPopoverCart.close()},afterCartClose:function(){this._oPopoverCart.destroy();this._oPopoverCart=null},onImageOpen:function(e){var t=e.getSource().getParent().getParent().getBindingContextPath();var o=[];for(var r=0;r<5;r++){var i=t+"/ToPhotos/"+r+"/Content";if(this.allImageURLs[i]){o.push(new g({src:this.allImageURLs[i]}))}}this.pressDialog=new l({contentWidth:"75%",resizable:true,showHeader:false,draggable:true,content:new h({pages:o}),customHeader:new sap.m.OverflowToolbar({design:"Transparent",style:"Clear",content:[new sap.m.ToolbarSpacer,new d({type:"Emphasized",icon:"sap-icon://decline",press:function(){this.pressDialog.close()}.bind(this)})]})});this.getView().addDependent(this.pressDialog);this.pressDialog.open();this.pressDialog.setInitialFocus(this.pressDialog.getCustomHeader().getContent()[1])},onFullScreen:function(){this.getRouter().navTo("comparisonCart")},onSelectProduct:function(e){var t=e.getSource();var o=t.getParent().getBindingContext().getPath();var r=this;if(!this.loadedWeights[o]){this.loadProdWeights(o.split("'")[o.split("'").length-2]).then(function(e){r.loadedWeights[o]=e.ProdWeights;r.getView().getModel("local").setProperty("/ProdWeights",e.ProdWeights)})}else{var i=JSON.parse(JSON.stringify(this.loadedWeights[o]));var a=this.getOwnerComponent().getModel("local").getProperty("/addedWeights");this.getView().getModel("local").setProperty("/ProdWeights",i)}debugger;if(!this._oPopover){n.load({name:"sap.ui.demo.cart.fragments.productDetails",controller:this}).then(function(e){this._oPopover=e;this.getView().addDependent(this._oPopover);this._oPopover.bindElement(o);this._oPopover.openBy(t)}.bind(this))}else{this._oPopover.bindElement(o);this._oPopover.openBy(t)}},handleCloseButton:function(){this._oPopover.close()},onExit:function(){if(this._oPopover){this._oPopover.destroy()}},onRefresh:function(){var e=this.byId("gridList");var t=false;var o=e.getBinding("items");var a=function(){o.detachDataReceived(a)}.bind(this);o.attachDataReceived(a);if(o){if(t){var s=new r("Name",i.Contains,oSearchField.getValue());o.filter([s])}else{o.filter([])}}},onBack:function(){this.getRouter().navTo("categories")}})});