sap.ui.define(["sap/ui/demo/cart/controller/BaseController","sap/base/util/deepExtend","sap/ui/core/syncStyleClass","sap/ui/core/mvc/Controller","sap/m/ObjectMarker","sap/m/MessageToast","sap/m/UploadCollectionParameter","sap/m/library","sap/ui/model/json/JSONModel","sap/ui/core/format/FileSizeFormat","sap/ui/Device","sap/ui/demo/cart/model/formatter","sap/m/Dialog","sap/ui/core/Fragment","sap/m/MessageBox"],function(e,t,r,a,o,i,s,n,g,l,h,c,d,u,p){"use strict";var P=n.ListMode,m=n.ListSeparators;return e.extend("sap.ui.demo.cart.controller.Camera",{formatter:c,onInit:function(){var e=this.getOwnerComponent().getRouter();e.getRoute("AddProduct").attachMatched(this._onRouteMatched,this);var t=this;u.load({id:"idStoneFragment",name:"sap.ui.demo.cart.fragments.stones",controller:this}).then(function(e){t.weightPopup=e;t.oModelStone=new sap.ui.model.json.JSONModel({items:[]});t.oModelStone.setDefaultBindingMode("TwoWay");t.weightPopup.setModel(t.oModelStone);t.weightPopup.setTitle("Less Weights");t.getView().addDependent(t.weightPopup)})},_onRouteMatched:function(){var e=this;this._oLocalModel=this.getOwnerComponent().getModel("local");this.mode="Create";this.setMode();this.lastTwoDisplay()},getAllItems:function(e,t){var r=e.getSelectedItems();var a=[];if(t){for(var o=0;o<r.length;o++){a.push(r[o].getBindingContext().getPath())}}else{for(var o=0;o<r.length;o++){a.push(r[o].getBindingContext("local").getPath())}}return a},fixedDialog:{},takePhoto:function(){var e=this;this.fixedDialog=new d({title:"Click on Capture to take photo",beginButton:new sap.m.Button({text:"Capture Photo",press:function(t){e.imageVal=document.getElementById("player");debugger;let r=new ImageCapture(e.stream.getVideoTracks()[0]);var a=e;r.takePhoto().then(e=>{a.imageContent=e;var t=a;var r=new FileReader;var o=URL.createObjectURL(e);r.readAsDataURL(e);r.onloadend=function(){debugger;var e=t.getModel("local").getProperty("/allImages");e.push({Stream:o,Content:r.result});t.getModel("local").setProperty("/allImages",e);t.stream.getTracks().forEach(function(e){e.stop()});t.fixedDialog.close();t.fixedDialog.destroy()}}).catch(e=>console.log(e))}}),content:[new sap.ui.core.HTML({content:"<video id='player' autoplay></video>"})],endButton:new sap.m.Button({text:"Cancel",press:function(){e.stream.getTracks().forEach(function(e){e.stop()});e.fixedDialog.close();e.fixedDialog.destroy()}})});this.getView().addDependent(this.fixedDialog);this.fixedDialog.open();this.fixedDialog.attachBeforeClose(this.setImage,this);var t=function(t){player.srcObject=t;e.stream=t};navigator.mediaDevices.getUserMedia({video:true}).then(t)},imageVal:"",onDelete:function(e){var t=this.getAllItems(e.getSource().getParent().getParent(),false);t=this.reverseSort(t,"allImages");var r=this;for(var a=0;a<t.length;a++){var o=this.getView().getModel("local").getProperty(t[a]);if(o.id){if(o.id!==""){r._deletedImages.push({id:o.id});r.getView().getModel("local").setProperty("/deleteImages",r._deletedImages);r.getView().getModel("local").setProperty("/checkChange",true)}}else{}this.deleteImage(o.Stream)}e.getSource().getParent().getParent().removeSelections()},deleteImage:function(e){var t=this.getView().getModel("local").getProperty("/allImages");for(var r=0;r<t.length;r++){if(t[r].Stream===e){t.splice(r,1);break}}this.getView().getModel("local").setProperty("/allImages",t)},onUploadChange:function(e){debugger;const t=e.getParameter("files");var r=this;var a=this.getView().getModel("local").getProperty("/allImages");if(!t.length){}else{for(let e=0;e<t.length;e++){var o=new FileReader;o.onload=function(e){var t=r.getView().getModel("local").getProperty("/allImages");try{var a=e.currentTarget.result;for(var o=0;o<t.length;o++){if(!t[o].Content){t[o].Content=a;r.getView().getModel("local").setProperty("/checkChange",true);r.getView().getModel("local").setProperty("/allImages",t);break}}}catch(e){}};var i={Stream:"",Content:""};i.Stream=URL.createObjectURL(t[e]);o.readAsDataURL(t[e]);a.push(i);this.getView().getModel("local").setProperty("/allImages",a)}}},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_bindView:function(e){},_onBindingChange:function(){},onDeleteRow:function(){var e=this.getView().byId("idTab");var t=this.getAllItems(e);var r=e.getModel("local");t=this.reverseSort(t,"ProdWeights");var a=r.getProperty("/ProdWeights");for(var o=0;o<t.length;o++){var i=parseInt(t[o].split("/")[2]);a.splice(i,1)}r.setProperty("/ProdWeights",a);this.getView().getModel("local").setProperty("/checkChange",true)},onInsert:function(e){var t=this._oLocalModel.getProperty("/Product/Tunch");var r=this._oLocalModel.getProperty("/Product/Wastage");if(t===""&&r===""||t==="0"&&r==="0"||t===0&&r===0){i.show("Please add Tunch First");return}var a=this._prepModelInitialValues();var o=this.getView().getModel("local");var s=o.getProperty("/ProdWeights");s.push(a);o.setProperty("/ProdWeights",s);this.getView().getModel("local").setProperty("/checkChange",true);this.getView().byId("td1").focus();this.getView().byId("__component0---Camera--td1").focus();this.add="X";var n=this.getView().byId("idTab");var g=this;n.addEventDelegate({onAfterRendering:function(e){g.setupTabHandling(n)}},n)},setupTabHandling:function(e){var t=e.getId();var r=this.getView().byId(t).getItems();var a=r.length;var o=this.getView().byId(t).getItems()[a-1];var i=o.getAggregation("cells");var s=this;if(this.add==="X"){i[0].focus()}var n,g,l,h},ontd1:function(){},weightPopup:null,oModelStone:{},itemPath:"",AllValues:[],onLessPopup:function(e){var t=e.getSource().getValue();var r=e.getSource().getBindingContext("local").getPath();var a=r.split("/")[r.split("/").length-1];var o=this.getView().getModel("local");this.AllValues=[];var i=o.getProperty("/ProdWeights/"+a+"/Values");if(i===undefined){i=[]}if(i.length>0){this.AllValues=JSON.parse(JSON.stringify(i))}this.itemPath="/ProdWeights/"+a+"/Values";this.oModelStone.setProperty("/items",i);this.weightPopup.open();this.weightPopup.setInitialFocus(this.weightPopup.getButtons()[0])},onStoneDeleteRow:function(){var e=this.getView().getDependents()[0].getContent()[0];var t=this.getAllItems(e,true);var r=e.getModel();t=this.reverseSort(t,"items");var a=r.getProperty("/items");for(var o=0;o<t.length;o++){var i=parseInt(t[o].split("/")[2]);a.splice(i,1)}r.setProperty("/items",a);this.getView().getModel("local").setProperty("/checkChange",true)},onOKStone:function(){var e=this.getView().getModel("local");var t=this.oModelStone.getProperty("/items");var r=0,a=0,o=0;for(var i=0;i<t.length;i++){if(t[i].MoreAmount<=0&&t[i].Net<=0){p.error("Please enter valid values");return}r=r+parseInt(t[i].MoreAmount);a=a+parseFloat(t[i].Net)}e.setProperty(this.itemPath,t);var s=this.itemPath.replace("/Values","");var n=e.getProperty(s);e.setProperty(s+"/LessWeight",a);n.NetWeight=n.GrossWeight-a;if(n.NetWeight){n.NetWeight=n.NetWeight.toFixed(3);var g=e.getProperty("/Product/Tunch");var l=e.getProperty("/Product/Wastage");g=parseFloat(g)+parseFloat(l);var h=n.Quantity;o=n.NetWeight*h;o=o*g/100;o=o.toFixed(3);e.setProperty(s+"/NetWeight",n.NetWeight);e.setProperty(s+"/Fine",o);e.setProperty(s+"/MoreAmount",r);var c=parseFloat(e.getProperty("/Product/Making"));var d=0;if(c>0){r=c*n.GrossWeight+r}e.setProperty(s+"/Amount",r)}this.weightPopup.close()},onCloseStone:function(){this.getView().getModel("local").setProperty(this.itemPath,this.AllValues);this.weightPopup.close()},onItemChange:function(e){var t=e.getSource().getName();var r=e.getSource().getParent().getBindingContextPath();var a=e.getSource().getParent().getModel();var o=a.getProperty(r);switch(o.Item){case"CST":o.Type="Gm";break;case"MLW":o.Type="Gm";break;case"MTW":o.Type="Gm";break;case"SRM":o.Type="Gm";break;case"OTH":o.Type="Pc";break;case"STW":o.Type="Pc";break;case"DMD":o.Type="Ct";break;case"POL":o.Type="Ct";break;default:}a.setProperty(r+"/Type",o.Type);this.onStChange(e)},onStChange:function(e){debugger;var t=e.getSource().getName();var r=e.getSource().getParent().getBindingContextPath();var a=e.getSource().getParent().getModel();var o=a.getProperty(r);var i=0,s=0,n=0,g=0,l=0,h=0;n=parseFloat(o.Weight);s=parseFloat(o.Rate);h=parseFloat(o.Pc);switch(t){case"Weight":n=parseFloat(e.getParameter("newValue"));break;case"Rate":s=parseFloat(e.getParameter("newValue"));break;case"Pc":h=parseFloat(e.getParameter("newValue"));break;default:}switch(o.Type){case"Gm":g=s*n;l=n;break;case"Pc":g=h*s;l=n;break;case"Ct":g=s*n;l=n/5;break}if(isNaN(g)){g=0}else{g=g.toFixed(0)}if(isNaN(l)){l=0}else{l=l.toFixed(3)}a.setProperty(r+"/MoreAmount",g);a.setProperty(r+"/Net",l);this.getView().getModel("local").setProperty("/checkChange",true)},focusTableInput:function(e){debugger},onStoneInsert:function(e){var t={Item:"OTH",Type:"Pc",Pc:0,Weight:0,Rate:0,MoreAmount:0,Amount:0,Size:"",Labor:"",Tunch:0,Extra1:"",Extra2:0};var r=this.getView().getDependents()[0].getContent()[0];var a=r.getModel().getProperty("/items");a.push(t);r.getModel().setProperty("/items",a);this.getView().getModel("local").setProperty("/checkChange",true);setTimeout(function(){r.getItems()[r.getItems().length-1].getCells()[2].focus()},200)},onFocus:function(){i.show("ye")},onChange:function(e){var t=e.getSource().getValue();var r=e.getSource().getBindingContext("local").getPath();var a=r.split("/")[r.split("/").length-1];var o=this.getView().getModel("local");var i=o.getProperty("/Product/Tunch");var s=o.getProperty("/Product/Wastage");var n=o.getProperty("/Product/Making");i=parseFloat(i)+parseFloat(s);var g=o.getProperty("/ProdWeights/"+a+"/GrossWeight");var l=o.getProperty("/ProdWeights/"+a+"/LessWeight");var h=o.getProperty("/ProdWeights/"+a+"/Quantity");var c=o.getProperty("/ProdWeights/"+a+"/OtherChrg");if(isNaN(t)){t=0}if(isNaN(g)){g=0}if(isNaN(l)){l=0}for(var d=0;d<e.getSource().getParent().getCells().length;d++){var u=e.getSource().getName();if(u==="GrossWeight"){g=t;break}else if(u==="OtherChrg"){c=t;break}else if(u==="LessWeight"){l=t;break}else if(u==="Quantity"){h=t;break}}t=g-l;t=t.toFixed(3);o.setProperty("/ProdWeights/"+a+"/NetWeight",t);t=t*h;t=t*i/100;t=t.toFixed(3);o.setProperty("/ProdWeights/"+a+"/Fine",t);t=0;t=parseInt(o.getProperty("/ProdWeights/"+a+"/MoreAmount"));if(g===""){g=0}if(n===""){n=0}var p=parseFloat(g)*parseFloat(n);t=t+parseInt(c)+parseInt(p);t=t.toFixed();if(isNaN(t)){t=0}o.setProperty("/ProdWeights/"+a+"/Amount",t);this.getView().getModel("local").setProperty("/checkChange",true)},_prepModelInitialValues:function(){return{ProductId:"null",PairSize:0,OtherChrg:0,GrossWeight:0,LessWeight:0,NetWeight:0,Quantity:1,Fine:0,MoreAmount:0,Amount:0,Values:[],Status:"A",SoldOn:new Date,OrderId:"",Remarks:"null",CreatedOn:new Date,CreatedBy:""}}})});