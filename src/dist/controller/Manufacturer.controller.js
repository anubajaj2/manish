sap.ui.define(["sap/ui/demo/cart/controller/BaseController","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/demo/cart/model/formatter","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/SelectDialog","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,r,a,o,i,n,s,u,l,d){"use strict";var g;var c="false";var h=[];var f=l.EdmType;return e.extend("sap.ui.demo.cart.controller.Manufacturer",{formatter:o,onInit:function(){var e=new r({buttonText:"Save",deleteEnabled:false,blockStatus:false});this.setModel(e,"viewModel");var t=this.getRouter();t.getRoute("Manufacturer").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){var t=this;this.getView().setBusy(true);var o=this.getView().getModel("viewModel");o.setProperty("/codeEnabled",true);o.setProperty("/buttonText","Save");o.setProperty("/deleteEnabled",false);o.setProperty("/blockStatus",false);o.setProperty("/emailStatus",true);o.setProperty("/PatternStatus",true);var i=new r({groupCodeState:"None",emailState:"None",PatternState:"None"});this.setModel(i,"dataModel");var n=new r;var s=new r;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Manufacturers","GET",{},{},this).then(function(e){n.setData(e);t.getView().setModel(n,"manufactureModelInfo");t.getView().setBusy(false)}).catch(function(e){t.getView().setBusy(false);a.show("cannot fetch the data")});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Groups","GET",{},{},this).then(function(e){s.setData(e);t.getView().setModel(s,"groupModelInfo")}).catch(function(e){a.show("cannot fetch the data")})},onManufacturerSearch:function(e){var t=e.getSource().getValue();var r=[new n({path:"CustomerCode",operator:s.Contains,value1:t}),new n({path:"EmailId",operator:s.Contains,value1:t}),new n({path:"Name",operator:s.Contains,value1:t})];e.getSource().getParent().getParent().getBinding("rows").filter(new n({filters:r,and:false}))},createColumnConfig:function(){var e=[];e.push({label:"Full name",property:"Name",type:f.String});e.push({label:"Code",type:f.String,property:"CustomerCode"});e.push({label:"City",property:"City",type:f.String});e.push({label:"Address",property:"Address",type:f.String});e.push({label:"Mobile",property:"MobilePhone",type:f.String});e.push({label:"E-mail",property:"EmailId",type:f.String});e.push({label:"Status",property:"Status",type:f.String});return e},onDownloadRetailersData:function(){var e,t,r,a,o;if(!this._oTable){this._oTable=this.byId("customerTable")}o=this._oTable;t=o.getBinding("rows");e=this.createColumnConfig();var i=t.getModel();r={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:{type:"odata",dataUrl:t.getDownloadUrl?t.getDownloadUrl():null,serviceUrl:this._sServiceUrl,headers:i.getHeaders?i.getHeaders():null,count:t.getLength?t.getLength():null,useBatch:true},fileName:"Table export sample.xlsx",worker:false};a=new d(r);a.build().finally(function(){a.destroy()})},clearScreen:function(){var e=this.getView().getModel("local").getProperty("/Manufacturer");var t=this.getView().getModel("viewModel");var r=this.getView().getModel("dataModel");var a=this.getView().getModel("local").getProperty("/groupSelected");a.GroupCode="";a.GroupId="";this.getView().getModel("local").setProperty("/groupSelected",a);e.CustomerCode="";e.Name="";e.Address="";e.City="";e.MobilePhone="";e.EmailId="";e.Status="";e.Pattern="";e.Categories=[];e.Groups=[];t.setProperty("/codeEnabled",true);t.setProperty("/buttonText","Save");t.setProperty("/deleteEnabled",false);t.setProperty("/blockStatus",false);r.setProperty("/groupCodeState","None");r.setProperty("/emailState","None");r.setProperty("/PatternState","None");this.getView().getModel("local").setProperty("/Manufacturer",e)},CheckEmailExists:function(e){var t=this;var r=this.getView().getModel("manufactureModelInfo").getData().results;function a(e){return r.filter(function(t){return t.EmailId===e})}var o=a(e);if(o.length>0){return true}},CheckPatternExists:function(e){var t=this;var r=this.getView().getModel("manufactureModelInfo").getData().results;function a(e){return r.filter(function(t){return t.Pattern===e})}var o=a(e);if(o.length>0){return true}},manufacturerCheck1:function(e){var t=this;var r=this.getView().getModel("manufactureModelInfo").getData().results;function a(e){return r.filter(function(t){return t.CustomerCode===e})}if(r&&r.length>0){var o=a(e);if(o.length>0){var i=o[0].id}else{var i=""}}return i},onManufacturerSelect:function(e){var t=e.getSource().getRows()[e.getSource().getSelectedIndex()].getCells()[0].getText();this.manufacturerCheck(t)},onCustomerFilter:function(e){if(!this.oDialog){var t=this.getView().getModel("manufactureModelInfo").getProperty("/results");var r=new Set;t.forEach(e=>{r.add(e.City)});t=[];r.forEach(e=>{t.push({City:e})});this.getView().getModel("manufactureModelInfo").setProperty("/uniqueCities",t);this.oDialog=new u({title:"Select Cities",multiSelect:true,search:this.searchCityFilter.bind(this),confirm:this.filterConfirm.bind(this),cancel:this.filterCancel.bind(this)});this.getView().addDependent(this.oDialog);this.oDialog.setModel(this.getView().getModel("manufactureModelInfo"));this.oDialog.bindAggregation("items",{path:"/uniqueCities",template:new sap.m.DisplayListItem({label:"{City}"})});this.oDialog.open()}else{this.oDialog.open()}},searchCityFilter:function(e){var t=e.getParameter("value");var r=new n({path:"City",operator:s.Contains,value1:t});this.oDialog.getBinding("items").filter([r])},filterConfirm:function(e){var t=e.getParameter("selectedItems");var r=[];t.forEach(e=>{r.push(new n({path:"City",operator:s.Contains,value1:e.getLabel()}))});this.getView().byId("customerTable").getBinding("rows").filter(new n({filters:r,and:false}))},filterCancel:function(){this.getView().byId("customerTable").getBinding("rows").filter([])},manufacturerCheck:function(e){var t=this;var r=this.getView().getModel("manufactureModelInfo").getData().results;debugger;function a(e){return r.filter(function(t){return t.CustomerCode===e})}if(r&&r.length>0){var o=a(e);if(o.length>0){var i=this.getView().getModel("viewModel");var u=i.getProperty("/blockStatus");var l=this.getView().getModel("local").getProperty("/Manufacturer");l.CustomerCode=o[0].CustomerCode;l.Address=o[0].Address;l.Name=o[0].Name;l.City=o[0].City;l.MobilePhone=o[0].MobilePhone;l.Groups=o[0].Groups;l.Categories=o[0].Categories;l.EmailId=o[0].EmailId;l.Pattern=o[0].Pattern;if(o[0].Status==="B"){i.setProperty("/blockStatus",false)}else if(o[0].Status==="U"){i.setProperty("/blockStatus",true)}if(o[0].id){var d=new n({filters:[new n("ManufacturerId",s.EQ,o[0].id)]});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/ManuGroups","GET",d,{},this).then(function(e){for(var r=0;r<e.results.length;r++){var a=e.results[r].GroupId;var o=getGroupDetail(a);debugger;var i=t.getView().getModel("local").getProperty("/groupSelected");t.getView().getModel("local").setProperty("/groupSelected/GroupCode",o[r].groupCode);t.getView().getModel("local").setProperty("/groupSelected/GroupId",o[r].id);t.getView().getModel("local").setProperty("/groupSelected/ManuId",e.results[r].id);i.GroupCode=o[r].groupCode;i.GroupId=o[r].id;i.ManuId=o[r].oData.results[r].id;var e=JSON.parse(JSON.stringify(i));h.push(e)}}).catch(function(e){})}i.setProperty("/buttonText","Update");i.setProperty("/deleteEnabled",true);i.setProperty("/codeEnabled",false);i.setProperty("/emailStatus",false);i.setProperty("/PatternStatus",false);return o[0].id}else{}}},updateGroup:function(e){var t=this;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/ManuGroups","GET",e,{},this).then(function(e){for(var r=0;r<e.results.length;r++){t.ODataHelper.callOData(t.getOwnerComponent().getModel(),"/ManuGroups('"+e.results.id+"')","DELETE ",{},{},t).then(function(e){debugger}).catch(function(e){debugger})}}).catch(function(e){t._onRouteMatched();a.show("Error in Update")})},ValidateManufacturerData:function(e){e.CustomerCode=e.CustomerCode.toUpperCase();if(e.Name&&e.Name!==""){e.Name=e.Name.toUpperCase()}if(e.Address&&e.Address!==""){e.Address=e.Address.toUpperCase()}if(e.City&&e.City!==""){e.City=e.City.toUpperCase()}if(e.Pattern&&e.Pattern!==""){e.Pattern=e.Pattern.toUpperCase();if(o.noSpace(this.getView().byId("idPattern"))!==true){return{status:false,error:"No Space Allowed"}}}if(e.EmailId&&e.EmailId!==""){e.EmailId=e.EmailId.toLowerCase();if(o.checkEmail(this.getView().byId("idEmail"))!==true){return{status:false,error:"InValid EmailId"}}if(o.noSpace(this.getView().byId("idEmail"))!==true){return{status:false,error:"No Space Allowed"}}}return{status:true,error:""}},ValidateDataCreation:function(e){if(this.CheckEmailExists(e.EmailId)===true){return{status:false,error:"EmailId already used for supplier"}}if(this.CheckPatternExists(e.Pattern)===true){return{status:false,error:"Pattern already used for supplier"}}return{status:true,error:""}},saveData:function(e){debugger;var t=this;var r=this.getView().getModel("dataModel");var o=this.getView().getModel("viewModel");var u=this.getView().getModel("local").getProperty("/Manufacturer");var l=this.getView().getModel("local").getProperty("/groupSelected/GroupId");if(u.CustomerCode!==""){var d=JSON.parse(JSON.stringify(u));if(o.getProperty("/blockStatus")===false){debugger;d.Status="B"}else{d.Status="U"}var g=this.ValidateManufacturerData(d);if(g.status===false){i.error(g.error);return}var h=this.manufacturerCheck1(d.CustomerCode);if(h){var f=new n({filters:[new n("ManufacturerId",s.EQ,h)]});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Manufacturers('"+h+"')","PUT",{},d,this).then(function(e){t._onRouteMatched();a.show("Data saved successfully");t.UpdateLocalModel();t.clearScreen()}).catch(function(e){a.show("Data could not be saved")});if(c==="true"){debugger;var t=this;this.updateGroup(f);for(var p=1;p<l.length;p++){var C=t.updateGroupDetails(l,p,h)}}if(this.onSwitch===true){debugger;var m={emailId:d.EmailId,name:d.Name,bStat:o.oData.blockStatus,Authorization:this.getModel("local").getProperty("/Authorization")};this.changeUserStatus(m)}}else{debugger;var g=this.ValidateDataCreation(d);if(g.status===false){i.error(g.error);return}this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Manufacturers","POST",{},d,this).then(function(e){debugger;a.show("Data saved sucessfully");t.clearScreen();t._onRouteMatched()}).catch(function(e){a.show("Data could not be saved")});debugger;var M={name:d.Name,emailId:d.EmailId,role:"Maker",Authorization:this.getModel("local").getProperty("/Authorization")};this.createUserPayload(M)}}else{var y=this.getView().byId("idCode");y.setValueState("Error");y.setValueStateText("Please enter a Code!")}},updateGroupDetails:function(e,t,r){var o=this;var i=this.getView().getModel("local").getProperty("/ManuGroup");var n=this.getView().getModel();if(e[t]!==""){i.ManufacturerId=r;i.GroupId=e[t];i.ChangedBy="";i.ChangedOn="";i.CreatedBy="";i.CreatedOn="";this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/ManuGroups","POST",{},i,this).then(function(e){i.ManufacturerId="";i.GroupId="";i.ChangedBy="";i.ChangedOn="";i.CreatedBy="";i.CreatedOn="";a.show("Data saved successfully");o.clearScreen()}).catch(function(e){i.ManufacturerId="";i.GroupId="";i.ChangedBy="";i.ChangedOn="";i.CreatedBy="";i.CreatedOn=""})}},onSwitch:function(e){var t=e.getParameters("Selected").state;return this.onSwitch=true},onSelectionChange:function(e){debugger;var t=e.getSource();var r=t.getSelectedItems();if(r.length>0){debugger;for(var a=0;a<r.length;a++){}}},groupCodeCheck:function(e){debugger;var t=e.getSource();c="true"},CodeCheck:function(e){debugger;var t=e.getParameter("newValue");var r=this.getView().getModel("viewModel");var a=this.manufacturerCheck(t);this.getView().byId("idName").focus()},deleteManufacturer:function(e){debugger;var t=this;var r=this.getView().getModel("local").getProperty("/Manufacturer");if(r.CustomerCode){var o=this.manufacturerCheck(r.CustomerCode);if(o){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Manufacturers('"+o+"')","DELETE",{},{},this).then(function(e){debugger;var r=t.getView().getModel("local").getProperty("/groupSelected");for(var o=0;o<r.length;o++){t.ODataHelper.callOData(t.getOwnerComponent().getModel(),"/ManuGroups('"+r.ManuId+"')","DELETE ",{},{},t).then(function(e){debugger}).catch(function(e){debugger})}t.clearScreen();t._onRouteMatched();a.show("Entry Deleted Sucessfully")}).catch(function(e){t._onRouteMatched();a.show("Could not delete the entry")})}}},onNameEnt:function(e){this.getView().byId("idName").setValue(e.getParameter("value").toUpperCase());this.getView().byId("idAddress").focus()},onAddrEnt:function(e){this.getView().byId("idCity").focus()},onCityEnt:function(e){this.getView().byId("idContact").focus()},onContEnt:function(e){this.getView().byId("idgpCode").focus()},onPatternEnt:function(e){this.getView().byId("idBlock").focus()},onEmailEnt:function(e){this.getView().byId("idPattern").focus()},onSelectionFinish:function(){debugger;this.getView().byId("idCatCode").focus()},onSelectionFinish1:function(){debugger;this.getView().byId("idEmail").focus()},createUserPayload:function(e){debugger;$.post("/createNewUser",e).then(function(e){debugger}).fail(function(e){sap.m.MessageBox.error("User Creation failed")})},changeUserStatus:function(e){debugger;$.post("/changeUserStatus",e).then(function(e){debugger}).fail(function(e){sap.m.MessageBox.error("Changing User Status failed")})},UpdateLocalModel:function(e){var t=this;var r=this.getView().byId("idCode").getValue();var a=this.getView().getModel("manufactureModelInfo").getData().results;function o(e){return a.filter(function(t){return t.CustomerCode===e})}if(a&&a.length>0){var i=o(r);if(i.length>0){var n=this.getView().getModel("viewModel");var s=n.getProperty("/blockStatus");var u=this.getView().getModel("local").getProperty("/Manufacturer");i[0].CustomerCode=u.CustomerCode;i[0].Address=u.Address;i[0].Name=u.Name;i[0].City=u.City;i[0].MobilePhone=u.MobilePhone;i[0].EmailId=u.EmailId;i[0].Groups=u.Groups;i[0].Categories=u.Categories;i[0].Pattern=u.Pattern;var l=this.getView().getModel("local").getProperty("/groupSelected");if(s===false){i[0].Status="B"}else if(s===true){i[0].Status="U"}}}}})});