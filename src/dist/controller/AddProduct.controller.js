sap.ui.define(["sap/ui/demo/cart/controller/BaseController","sap/ui/demo/cart/model/formatter","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ui/core/HTML","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,o,r,a,i,s){"use strict";return e.extend("sap.ui.demo.cart.controller.AddProduct",{formatter:t,onInit:function(){this._oRouter=o.getRouterFor(this);var e=new r({images:[]});this.getView().setModel(e,"C");this.a=[];this._oRouter.getRoute("AddProduct").attachMatched(this._routePatternMatched,this);this._oLocalModel=this.getOwnerComponent().getModel("local")},onPopUpSearch:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("ProductId",sap.ui.model.FilterOperator.Contains,t)]});var r=e.getSource();r.getBinding("items").filter(o)},setAvailableProductCode:function(){this.pattern=this.getView().getModel("local").getProperty("/ManufacturerData/Pattern");var e=new sap.ui.model.Filter("CreatedBy",sap.ui.model.FilterOperator.EQ,"'"+this.createdBy+"'");var t=this;t.ODataHelper.callOData(t.getOwnerComponent().getModel(),"/Products/$count","GET",{filters:[e]},{},t).then(function(e){e=parseInt(e)+1;t.getView().byId("idName").setValue(t.pattern+"_"+e.toString())})},_routePatternMatched:function(){this.loadCategories(this.getView().getModel("local").getProperty("/ManufacturerData/Categories"));if(this.getOwnerComponent().getModel("local").getProperty("/Authorization")===""){this.logOutApp()}this.lastTwoDisplay();this.createdBy=this.getView().getModel("local").getProperty("/CurrentUser");this.setAvailableProductCode()},onDelete:function(){var e=this;var t=this.getView().byId("idName").getValue();$.post("/DeleteProduct",{productCode:t}).done(function(t,o){if(t.startsWith("id")){var r=e.getView().getModel("local").getProperty("/ProdWeights");r.forEach(t=>{e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/ProdWeights('"+t.id+"')","DELETE",{},{},e)});var a=e.getView().getModel("local").getProperty("/allImages");a.forEach(t=>{e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/Photos('"+t.id+"')","DELETE",{},{},e)});var s=t.split(":")[1];var d=e;e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/Products('"+s+"')","DELETE",{},{},e).then(function(e){d.onCancel();i.show("Product deleted successfully");d.ProductsearchPopup=null})}else{i.show(t);e.ProductsearchPopup=null}}).fail(function(e,t,o){})},onCancel:function(){debugger;if(this.cancelSave()===true){this._oLocalModel.setProperty("/Product",{id:"",ProductId:"",Name:"",Category:"",SubCategory:"",Type:"S",PairType:2,ShortDescription:"null",ItemType:"G",Karat:"22/22",Gender:"F",OverallStatus:"N",ProdStatus:"A",HindiName:"",Tunch:0,Wastage:0,Making:0,ApprovedOn:"",AlertQuantity:0,CreatedBy:"",CreatedOn:"",ChangedBy:"",ChangedOn:""});this.mode="Create";this.setMode();this.setAvailableProductCode()}},onChange:function(){this.getView().getModel("local").setProperty("/checkChange",true)},onSave:function(){var e=this;var t=this._oLocalModel.getProperty("/Product");var o=t.ProductId;var r=e.validateProductData();if(r.status===false){s.error(r.error);return}t.ProductId=o.toUpperCase();t.Tunch=parseFloat(t.Tunch).toFixed(2);t.Wastage=parseFloat(t.Wastage).toFixed(0);t.GrossWeight=this.getView().getModel("local").getProperty("/ProdWeights")[0].GrossWeight;var a=new sap.ui.model.Filter("ProductId","EQ",this.getView().byId("idName").getValue());if(this.mode==="Edit"){delete t.ToChangedBy;delete t.ToCreatedBy;delete t.ToOrder;delete t.ToPhotos;delete t.ToWeights;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Products('"+t.id+"')","PUT",{},t,this).then(function(o){e.performCameraSave(t.id);i.show("Product Updated Successfully");e.getView().getModel("local").setProperty("/checkChange",false);e.mode="Edit";e.setMode();setTimeout(()=>{e.onCancel()},900)}).catch(function(e){s.error("Error while saving product data")})}else if(this.mode==="Copy"){delete t.ToChangedBy;delete t.ToCreatedBy;delete t.ToOrder;delete t.ToPhotos;delete t.ToWeights;delete t.id;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Products","GET",{filters:[a]},{},this).then(function(o){if(o.results.length!=0){s.error("Product Id Already Exist")}else{var r=e;e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/Products","POST",{},t,e).then(function(e){r.performCameraSave(e.id);i.show("Product Created Successfully");r.getView().getModel("local").setProperty("/Product",e);r.getView().getModel("local").setProperty("/checkChange",false);setTimeout(()=>{r.onCancel()},900)}).catch(function(e){s.error("Error while saving product data")})}})}else{this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Products","GET",{filters:[a]},{},this).then(function(o){if(o.results.length!=0){s.error("Product Id Already Exist")}else{var r=e;e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/Products","POST",{},t,e).then(function(e){r.performCameraSave(e.id);i.show("Product Created Successfully");r.getView().getModel("local").setProperty("/Product",e);r.getView().getModel("local").setProperty("/checkChange",false);r.mode="Edit";r.setMode();setTimeout(()=>{r.onCancel()},900)}).catch(function(e){s.error("Error while saving product data")})}})}},allImageURLs:[],counter:function(e){var o=e.getItems();var r=this.getView().getModel("local");var a=this.getView().getModel();for(var i=0;i<o.length;i++){var s=o[i].getBindingContextPath();var d=a.getProperty(s+"/ToPhotos");var n=s+"/ToPhotos/0/Content";var l=t.getImageUrlFromContent(a.getProperty(n));if(!this.allImageURLs[n]){this.allImageURLs[n]=l}o[i].setIcon(l)}},onProductValueHelp:function(e){if(!this.ProductsearchPopup){this.ProductsearchPopup=new sap.ui.xmlfragment("sap.ui.demo.cart.fragments.popup0",this);this.getView().addDependent(this.ProductsearchPopup);var t=this.getView().getModel("i18n").getProperty("Products");this.ProductsearchPopup.setTitle(t);var o=new sap.ui.model.Filter("CreatedBy",sap.ui.model.FilterOperator.EQ,"'"+this.createdBy+"'");this.ProductsearchPopup.bindAggregation("items",{path:"/Products",parameters:{expand:"ToPhotos",top:1},filters:[o],template:new sap.m.StandardListItem({title:"{ProductId}",description:"{Category} / {SubCategory} / {Name}"})});setTimeout(()=>{this.counter(this.ProductsearchPopup)},4e3);this.ProductsearchPopup.open()}else{this.counter(this.ProductsearchPopup);this.ProductsearchPopup.open()}},onConfirm:function(e){var t=this;var o=this.getView().getModel("local").getProperty("/Product");var r=e.getParameter("selectedItem").getTitle();o.ProductId=r;this.getView().byId("idName").fireSubmit()},onEnter:function(e){var t=this;var o=this.getView().byId("idName").getValue().toUpperCase();this.getView().byId("idName").setValue(o);var r=new sap.ui.model.Filter("ProductId","EQ",o);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Products","GET",{filters:[r]},{},this).then(function(e){if(e.results.length!=0){if(e.results[0].CreatedBy===t.createdBy){i.show("Product Already Exist");t.loadProductData(e.results[0].id);t.getView().getModel("local").setProperty("/Product",e.results[0]);t.mode="Edit";t.setMode()}else{i.show("Product Already Exist, Please choose a different name")}}else{i.show("Create as new product");t.getView().byId("idPName").focus()}});this.getView().byId("idPName").focus()},onCopy:function(){this.mode="Copy";this.setMode();this.setAvailableProductCode();i.show("Another copy created!, Edit & Save")},onEnterRemark:function(){this.getView().byId("idCat").focus()},onEnterCat:function(){this.getView().byId("idSubCat").focus()},onEnterSubCat:function(){this.getView().byId("idType").focus()},onEnterType:function(){this.getView().byId("idPairType").focus()},onEnterPairType:function(){this.getView().byId("idSD").focus()},onMaking:function(){this.getView().getParent().getParent().getCurrentMidColumnPage().byId("idTab").getItems()[0].getCells()[0].focus()},onWastage:function(){this.getView().byId("idMkg").focus()},onTunch:function(){this.getView().byId("idWastage").focus()},onGender:function(){this.getView().byId("idTunch").focus()},onKarat:function(){this.getView().byId("idGender").focus()},onSD:function(){this.getView().byId("idCat").focus()},onPairType:function(){this.getView().byId("idKarat").focus()},onCat:function(){this.getView().byId("idSubCat").focus()},onSubCat:function(){this.getView().byId("idType").focus()},onType:function(){this.getView().byId("idPairType").focus()}})});